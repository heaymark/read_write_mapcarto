<!DOCTYPE html>
<html>
<head>
    <title>Sismos Capas</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> <!-- movil -->
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>  <!-- caracteres -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- compativilidad -->
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- dispositivos -->
    <!-- <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script> -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
    
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.3/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.3/leaflet.draw.js"></script>
    <!-- <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" /> -->
    <!-- <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script> -->
    <!-- <link rel="stylesheet" href="libs/leaflet.css"/> -->
    <!-- <link rel="stylesheet" href="libsx0.7/leaflet.css"/> -->
    <!-- <link rel="stylesheet" href="src/leaflet.draw.css"/> -->
    <!-- <script src="libs/leaflet-src.js"></script> -->
    <!-- <script src="libsx0.7/leaflet-src.js"></script> -->

    <!-- <script src="src/Leaflet.draw.js"></script>
    <script src="src/Leaflet.Draw.Event.js"></script>

    <script src="src/edit/handler/Edit.Poly.js"></script>
    <script src="src/edit/handler/Edit.SimpleShape.js"></script>
    <script src="src/edit/handler/Edit.Rectangle.js"></script>
    <script src="src/edit/handler/Edit.Marker.js"></script>
  	<script src="src/edit/handler/Edit.CircleMarker.js"></script>
  	<script src="src/edit/handler/Edit.Circle.js"></script>

    <script src="src/draw/handler/Draw.Feature.js"></script>
    <script src="src/draw/handler/Draw.Polyline.js"></script>
    <script src="src/draw/handler/Draw.Polygon.js"></script>
    <script src="src/draw/handler/Draw.SimpleShape.js"></script>
    <script src="src/draw/handler/Draw.Rectangle.js"></script>
    <script src="src/draw/handler/Draw.Circle.js"></script>
    <script src="src/draw/handler/Draw.Marker.js"></script>
    <script src="src/draw/handler/Draw.CircleMarker.js"></script>

    <script src="src/ext/TouchEvents.js"></script>
    <script src="src/ext/LatLngUtil.js"></script>
    <script src="src/ext/GeometryUtil.js"></script>
    <script src="src/ext/LineUtil.Intersect.js"></script>
    <script src="src/ext/Polyline.Intersect.js"></script>
    <script src="src/ext/Polygon.Intersect.js"></script>

    <script src="src/Control.Draw.js"></script>
    <script src="src/Tooltip.js"></script>
    <script src="src/Toolbar.js"></script> 

    <script src="src/draw/DrawToolbar.js"></script>
    <script src="src/edit/EditToolbar.js"></script>
    <script src="src/edit/handler/EditToolbar.Edit.js"></script>
    <script src="src/edit/handler/EditToolbar.Delete.js"></script> -->
</head>
<body>
<div>
    <select class="form-control deleg" name="selectDel" id="selectDel">
        <!-- <option value="">TODAS</option>
        <option value="2" data-lat="19.4853167546877" data-lng="-99.1820729102214">AZCAPOTZALCO</option>
        <option value="3" data-lat="19.3806362549985" data-lng="-99.1611326141866">BENITO JUAREZ</option>
        <option value="1" data-lat="19.345588996402" data-lng="-99.2378692104112">ALVARO OBREGON</option>
        <option value="16" data-lat="19.240217770539" data-lng="-99.0916576113265">XOCHIMILCO</option>
        <option value="4" data-lat="19.3266341665147" data-lng="-99.150335760299">COYOACAN</option>
        <option value="5" data-lat="19.3231754659492" data-lng="-99.3107267391573">CUAJIMALPA</option>
        <option value="6" data-lat="19.4313723132379" data-lng="-99.1490420681939">CUAUHTEMOC</option>
        <option value="7" data-lat="19.5040412420979" data-lng="-99.1158738074004">GUSTAVO A. MADERO</option>
        <option value="8" data-lat="19.3969183944221" data-lng="-99.0943265445642">IZTACALCO</option>
        <option value="9" data-lat="19.3490212121847" data-lng="-99.0565144863756">IZTAPALAPA</option>
        <option value="10" data-lat="19.2699244753261" data-lng="-99.2726920780272">MAGDALENA CONTRERAS</option>
        <option value="11" data-lat="19.4285038332166" data-lng="-99.2047202939644">MIGUEL HIDALGO</option>
        <option value="12" data-lat="19.1400880550359" data-lng="-99.0482120531187">MILPA ALTA</option>
        <option value="13" data-lat="19.2769497908826" data-lng="-99.0028123071402">TLAHUAC</option>
        <option value="14" data-lat="19.1985168784299" data-lng="-99.2067309947676">TLALPAN</option>
        <option value="15" data-lat="19.4305420760671" data-lng="-99.0929907962767">VENUSTIANO CARRANZA</option> -->
    </select>
</div>
    <p></p>
</div>
<div id="map" style="width: 1200px; height: 600px; border: 1px solid #ccc"></div>
<!-- <button id="changeColor">Rectangle -> Blue</button> -->

<script>
var cartolayer, sltfeature, lyrs, mkrInicial, lyrRadio, maps, objlayerBase, highlight, dehighlight, select, layerbase, paramlayerbase, parammapbase, viz, vizparam, el, layers, user, api_key, clickCircle5, clickCircle8;
var geomTools;
var drawControl;
var layerbase = 'https://{s}.base.maps.api.here.com/maptile/2.1/maptile/newest/normal.day.grey/{z}/{x}/{y}/256/png8?lg=eng&token=A7tBPacePg9Mj_zghvKt9Q&app_id=KuYppsdXZznpffJsKT24';
var paramlayerbase = {
    minZoom: 0,
    maxZoom: 20,
    subdomains:"1234",
    attribution: "&copy;2017 HERE <a href='http://here.net/services/terms' target='_blank'>Terms of use</a>"
};
 
var parammapbase = {
    center: new L.LatLng(19.33123050921937,-99.09942626953125),
    zoom : 10,
    minZoom: 0,
    maxZoom: 20,
    attribution: "CARTO",
}

var mapdiv =  'map';

var param = {user : 'finanzasdf-admin',};

var viz = "https://finanzasdf.carto.com/u/finanzasdf-admin/api/v2/viz/57d594e1-98b7-4db3-9bc7-426e584834d2/viz.json";

$(function(){

    objlayerBase = L.tileLayer(layerbase,paramlayerbase);
    map = new L.Map(mapdiv, parammapbase), map.addLayer(objlayerBase);
    cartodb.createLayer(map,viz)
        .addTo(map)
        .on('done', function(layer){
            // if(navigator.geolocation){
            //     navigator.geolocation.getCurrentPosition(coords);
            // } else{
            //     map.setView(new L.latLng(19.4292441,-99.1272684),13);
            // }
            lyrs = layer;

            // console.log(lyrs); // capas desde carto
            // console.log(lyrs.layers[5].options.layer_name);//name table 
            // console.log(lyrs.layers); // cantidad de capas  cargadas

        // var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        //         osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        //         osm = L.tileLayer(osmUrl, {maxZoom: 20, attribution: osmAttrib}),
        //         map = new L.Map('map', {layers: [osm], center: new L.LatLng(19.33123050921937,-99.09942626953125), zoom: 12});

        }).error(function (err) {
            
            console.log(err);
        });

            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var objsql = new cartodb.SQL({ user : 'finanzasdf-admin' });
                //Empieza LAS DELEGACIIONES
                objsql.execute("SELECT * FROM delegaciones_df ORDER BY nombre ASC")
                .on("done",function(data){
                    $("<option />",{"value":"*","text":'Selecciona una delegacion...'}).appendTo("#selectDel");
                        for(idx in data.rows){
                            $("<option />",{"value":data.rows[idx].cartodb_id,"text":data.rows[idx].nombre}).appendTo("#selectDel");
                        }//Fin for(idx in data.rows){
                });//Fin .on("done",function(data){

                $('#selectDel').on("change",function(e){
                    var optiondelegacion = $("#selectDel").val();
                       // var intersql = "SELECT COUNT(*) FROM delegaciones_df dlg INNER JOIN sismo_capas sis ON ST_Contains(sis.the_geom,dlg.the_geom) WHERE dlg.cartodb_id = "+optiondelegacion;

                            // var strsql ='https://finanzasdf-admin.carto.com/api/v2/sql/?format=geojson&q=SELECT * FROM "finanzasdf-admin".sismo_capas_edit_seduvi'+where;
                            // var intersql = "SELECT * FROM delegaciones_df dlg INNER JOIN sismo_capas sis ON ST_Contains(sis.the_geom,dlg.the_geom) WHERE dlg.cartodb_id = "+optiondelegacion;
                            var intersql = "SELECT sismo_capas_edit_seduvi.the_geom_webmercator, sismo_capas_edit_seduvi.cartodb_id, sismo_capas_edit_seduvi.the_geom, sismo_capas_edit_seduvi.lat, sismo_capas_edit_seduvi.idregistro, sismo_capas_edit_seduvi.lng, sismo_capas_edit_seduvi.dependencia, sismo_capas_edit_seduvi.capa, sismo_capas_edit_seduvi.clas_global, sismo_capas_edit_seduvi.deleg, sismo_capas_edit_seduvi.estado, sismo_capas_edit_seduvi.cuentapredial, sismo_capas_edit_seduvi.coincidencia, sismo_capas_edit_seduvi.lat_predio, sismo_capas_edit_seduvi.lng_predio FROM sismo_capas_edit_seduvi INNER JOIN delegaciones_df ON ST_Contains(delegaciones_df.the_geom,sismo_capas_edit_seduvi.the_geom) WHERE delegaciones_df.cartodb_id = "+optiondelegacion;
                            // strsql = "SELECT COUNT(*) FROM alertas_alto_bajo_impacto alert INNER JOIN sectores sec ON ST_Contains(sec.the_geom,alert.the_geom) WHERE sec.nombre = '"+optionSectores+"'";
                            
                            // console.log(intersql);
                            var strsql ='https://finanzasdf-admin.carto.com/api/v2/sql/?format=geojson&q='+intersql;
                            
                            // console.log(strsql);//consulta con api
                            var semaforo;

                            $.getJSON(strsql, function(data) {
                                // console.log(data);
                              geojsonLayer = L.geoJson(data, {
                                onEachFeature: function (feature, layer) {
                                  // console.log(layer);
                                  // console.log(feature);
                                    if (feature.geometry.type === 'Point') {
                                        // layer.bindPopup('A popup!');
                                        // feature.properties.clas_global
                                        switch(feature.properties.clas_global) {
                                            case 0:
                                                semaforo = "Verde";
                                                break;
                                            case 1:
                                                semaforo = "Rojo";
                                                break;
                                            case 2:
                                                semaforo = "Amarillo";
                                                break;
                                            case 3:
                                                semaforo = "Sin captura";
                                                break;
                                            case 4:
                                                semaforo = "Rosa";
                                                break;
                                            case 'NULL':
                                                semaforo = "N/P";
                                        } 

                                        layer.bindPopup("<b>ID carto: </b>"+feature.properties.cartodb_id+"<br>"+
                                            "<b>Punto: </b>"+semaforo+"<br>"+
                                            "<b>ID registro: </b>"+feature.properties.idregistro+"<br>"+
                                            "<b>Latitud: </b>"+feature.properties.lat+"<br>"+
                                            "<b>Longitud: </b>"+feature.properties.lng+"<br>");
                                    }

                                    // map.addLayer(layer);
                                  layer.cartodb_id=feature.properties.cartodb_id;
                                  drawnItems.addLayer(layer);
                                }
                              });
                              map.addLayer(drawnItems);
                            });

                        bounry({user: "finanzasdf-admin"}, "delegaciones_df", "cartodb_id = "+optiondelegacion, "", map)

                })

            // var where = " WHERE deleg='cMilpaAlta'";

            var drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polyline: false,
                    polygon: false,
                    circle: false,
                    marker: false,
                    circlemarker: false,
                    rectangle: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: false
                }
            });
            map.addControl(drawControl);
            // console.log("Recibida1 "+layer);

            // map.on(L.Draw.Event.CREATED, function (e) {
            /*
                map.on('draw:created', function (e) {
                    var type = e.layerType,
                    console.log(e.layerType);
                        layer = e.layer;
                        console.log(layer);
                        // var layer = e.layers;

                    if (type === 'marker') {
                        layer.bindPopup('A popup!');
                    }

                    map.addLayer(layer);
                });
            */


            /*se cambio la funcion de edicion 
            map.on(L.Draw.Event.EDITED, function (e) {
                var layers = e.layers;
                var countOfEditedLayers = 0;
                layers.eachLayer(function (layer) {
                    countOfEditedLayers++;
                });
                // console.log("Edited " + countOfEditedLayers + " layers");
            });
            */

            map.on('draw:edited', function (e) {
                var layers = e.layers;
                // console.log(layers);
                layers.eachLayer(function (layer) {
                    if (layer instanceof L.Marker){
                        //Do marker specific actions7 here
                        // console.log(layer._latlng.lng); //obtenemos la long
                        // console.log(layer._latlng.lat); //obtenemos la lat 
                        // console.log(layer.cartodb_id); //obtenemos id carto
                        // console.log(layer.feature.properties); //obtenemos los registros
                        // console.log(layer.feature.properties.cartodb_id); //obtenemos los cartoid
                        // console.log(JSON.stringify(layer._latlng));
                                                
                        var sql = new cartodb.SQL({ user : 'finanzasdf-admin' });

                        var strsql ="UPDATE "+'"finanzasdf-admin"'+".sismo_capas_edit_seduvi SET the_geom = ST_SetSRID(st_makepoint("+layer._latlng.lng+", "+layer._latlng.lat+"),4326) WHERE cartodb_id = "+layer.cartodb_id;
                        // console.log(strsql);
                        $.getJSON("https://finanzasdf-admin.carto.com/api/v2/sql?q="+strsql+"&api_key=9636b95f3e6c01a780c65a869e491303ed330f9c", function(data){
                        // $.getJSON("https://finanzasdf-admin.carto.com/api/v2/sql?q="+strsql, function(data){
                             $.each(data.rows, function(key, val) {
                                 alert("llave "+key+" "+val);
                             });
                        });

                        // var geom = "ST_SetSRID(ST_GeomFromGeoJSON('"+JSON.stringify(layer._latlng)+"'),4326)";    
                        // var strsql ="UPDATE "+'"finanzasdf-admin"'+".sismo_capas_edit_seduvi SET (the_geom) VALUES ("+geom+") WHERE cartodb_id = "+layer.cartodb_id;
                        // var strsql ="UPDATE "+'"finanzasdf-admin"'+".sismo_capas_edit_seduvi SET the_geom = ST_SetSRID(st_makepoint("+layer._latlng.lng+", "+layer._latlng.lat+"),4326) WHERE cartodb_id = "+layer.cartodb_id;
                        // sql.execute("INSERT INTO "+'"finanzasdf-admin"'+" (capa, the_geom) VALUES (" + 2 +", "+lon+", '"+name+"', ST_SetSRID(ST_MakePoint(" + lon +", "+lat+"), 4326)) WHERE cartodb_id = "+layer.cartodb_id+"");
                        console.log(strsql);
                        // sql.execute(strsql);
                        // map.redraw();
                    }
                });
            });

            // L.DomUtil.get('changeColor').onclick = function () {
            //     drawControl.setDrawingOptions({rectangle: {shapeOptions: {color: '#004a80'}}});
            // };

            // map.on('click', function(e) {
            //     alert("longitud"+e.latlng.lat+", latitud"+e.latlng.lng)
               // $("#latitude").val(e.latlng.lat);
               // $("#longitude").val(e.latlng.lng);
            // });


            /*function fn_savegeom(SqlJson){
                alert(JSON.stringify(SqlJson));
                var geom = "ST_SetSRID(ST_GeomFromGeoJSON('"+JSON.stringify(SqlJson)+"'),4326)";    
                var sql_statement ="";
                switch(SqlJson.type){
                    case "Point":
                        // sql_statement = "INSERT INTO digitalizacionpoint (description,name,the_geom) VALUES('prueba','prueba',"+geom+")"; 
                        break
                    case "Linestring":
                        // sql_statement = "INSERT INTO digitalizacion (description,name,the_geom) VALUES('prueba','prueba',"+geom+")";
                        break;
                }
                // $.getJSON('https://valrapa.cartodb.com/api/v2/sql/?q='+sql_statement+'&api_key=6433e4d1a9ba1f251b81f2cf70c8b34ec7e13344', function(data) {
                $.getJSON('https://finanzasdf-admin.carto.com/api/v2/sql/?q='+sql_statement+'&api_key=9636b95f3e6c01a780c65a869e491303ed330f9c', function(data) {
                     $.each(data.rows, function(key, val) {
                         alert("llave "+key+" "+val);
                     });
                });
            }*/
        getPopupContent(lyrs);

            

        function getPopupContent(layer) {
            // Marker - add lat/long
            if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                return strLatLng(layer.getLatLng());
            // Circle - lat/long, radius
            } else if (layer instanceof L.Circle) {
                var center = layer.getLatLng(),
                    radius = layer.getRadius();
                return "Center: "+strLatLng(center)+"<br />"
                      +"Radius: "+_round(radius, 2)+" m";
            // Rectangle/Polygon - area
            } else if (layer instanceof L.Polygon) {
                var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                    area = L.GeometryUtil.geodesicArea(latlngs);
                return "Area: "+L.GeometryUtil.readableArea(area, true);
            // Polyline - distance
            } else if (layer instanceof L.Polyline) {
                var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                    distance = 0;
                if (latlngs.length < 2) {
                    return "Distance: N/A";
                } else {
                    for (var i = 0; i < latlngs.length-1; i++) {
                        distance += latlngs[i].distanceTo(latlngs[i+1]);
                    }
                    return "Distance: "+_round(distance, 2)+" m";
                }
            }
            return null;
        };

        /*
            map.on(L.Draw.Event.CREATED, function(event) {
            // map.on("draw.created", function(event) {
                var layer = event.layer;
                var content = getPopupContent(layer);
                if (content !== null) {
                    layer.bindPopup(content);
                }
                drawnItems.addLayer(layer);
            });
        */
       
        function coords(position){
            var bounds = new cartodb.SQL({
                user:'pedrovaldez'
            })
            var location =  "ST_GeographyFromText('POINT("+parseFloat(position.coords.longitude).toFixed(8)+" "+parseFloat(position.coords.latitude).toFixed(8)+")')";
            bounds.execute("select ST_Distance(the_geom,"+location+") as distance,ST_X(the_geom) as X,ST_Y(the_geom) as Y,the_geom from pedrovaldez.wifi order by 1 limit 1")
                .done(function(data){
                    latInicial = parseFloat(position.coords.latitude).toFixed(8);
                    lonInicial = parseFloat(position.coords.longitude).toFixed(8);
                    ptInicial = new L.latLng(latInicial,lonInicial);
                    ptFinal = new L.latLng(data.rows[0].y,data.rows[0].x);
                    featureGroup = new L.featureGroup();

                    iconPosicion = L.icon({
                        iconUrl: 'libs/images/marker-icon-2x.png',
                        iconRetinaUrl: 'libs/images/marker-icon-2x.png',
                        // iconUrl: './img/ubicacion_persona.png',
                        // iconRetinaUrl: './img/ubicacion_persona.png',
                        iconSize: [64, 64],
                        /*iconAnchor: [22, 94],
                        popupAnchor: [-3, -76],
                        shadowUrl: './img/posicion.jpg',
                        shadowRetinaUrl: './img/posicion.jpg',
                        shadowSize: [68, 95],
                        shadowAnchor: [22, 94]*/
                    });

                    // iconWifi = L.icon({
                        // iconUrl: './img/pointverde.jpg',
                        // iconRetinaUrl: './img/pointverde.jpg',
                        // iconSize: [64, 64]
                    // });


                    map.setView(ptInicial,13);          
                    var mkrInicial = L.marker(ptInicial,{icon:iconPosicion});
                    mkrInicial.addTo(map);
                    // var mkrFinal = L.marker(ptFinal);
                    // mkrFinal.addTo(map);
                    
            });
        }

        //Zoom in the map 
        function bounry(user,table,sqlfilter,layer,map) {
            var sqlExtent = new cartodb.SQL(user);
            //regresa la coordenada maxima de mi extend de la geometria
            var sql = "select max(xmax) as xmax,min(xmin) as xmin,max(ymax) as ymax,min(ymin) as ymin from (select ST_Xmax(ST_Extent(the_geom)) as xmax,ST_Xmin(ST_Extent(the_geom)) as xmin,ST_Ymax(ST_Extent(the_geom)) as ymax,ST_Ymin(ST_Extent(the_geom)) as ymin from " + table + " where " + sqlfilter + ") as ext"
            // console.log(sql);
            sqlExtent.execute(sql).done(function(data) {
                if (data.rows[0].ymax != '' && data.rows[0].ymin != '' && data.rows[0].xmax && data.rows[0].xmin != '') {
                    var southWest = L.latLng(data.rows[0].ymax, data.rows[0].xmin),
                    northEast = L.latLng(data.rows[0].ymin, data.rows[0].xmax),
                    bounds = L.latLngBounds(southWest, northEast);
                    map.fitBounds(bounds);
                    selectFeature(table,sqlfilter,layer);
                    // geojsondownload(table,sqlfilter,layer);
                } else {
                    console.log("errors: en la ejecucion del sql en cartodb");
                }
            }).error(function(errors) {
                console.log("errors:" + errors);
            });
        }

        //Select the poligon
        function selectFeature(table,sqlfilter,layer){

            if(map.hasLayer(sltfeature)){
                map.removeLayer(sltfeature);
            };
            // Get CartoDB selection as GeoJSON and Add to Map
            $.getJSON("https://develop.carto.com/api/v2/sql?format=GeoJSON&q=select * from " + table + " where " + sqlfilter, function(data){
            
                sltfeature = L.geoJson(data,{
                    style: function (feature) {
                        return {color:'#850200',
                        weight: 5,
                        opacity:0.5,
                        fillColor:'#C4C5C6',
                        fillOpacity:0.2}
                    },
                    onEachFeature: function (feature, layer) {
                        layer.on({
                            click: function select(e) {
                                select(e.target);
                           }
                        });
                    }
                }).addTo(map);
                sltfeature.bringToBack();
            });
        }
        
});
</script>
</body>
</html>
